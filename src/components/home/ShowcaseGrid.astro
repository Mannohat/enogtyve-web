---
import { getCollection } from "astro:content";

const blogPosts = await getCollection("blog", ({ id }) => id.startsWith("da/"));
const latestPosts = blogPosts
	.sort(
		(a, b) =>
			new Date(b.data.pubDate).getTime() -
			new Date(a.data.pubDate).getTime(),
	)
	.slice(0, 3);
---

<section class="content-showcase">
	<div class="showcase-grid">
		<div class="showcase-box featured-news">
			<div class="box-header">
				<h3>üìù Seneste Blog Posts</h3>
				<span class="box-badge">Blog</span>
			</div>
			<div class="box-content">
				{
					latestPosts.map((post) => {
						const slug = post.slug.replace("da/", "");
						const date = new Date(
							post.data.pubDate,
						).toLocaleDateString("da-DK", {
							day: "2-digit",
							month: "2-digit",
							year: "numeric",
						});
						return (
							<a href={`/da/blog/${slug}`} class="news-item">
								<div class="news-date">{date}</div>
								<div class="news-title">{post.data.title}</div>
								<div class="news-excerpt">
									{post.data.description}
								</div>
							</a>
						);
					})
				}
			</div>
		</div>

		<div class="showcase-box upcoming-events">
			<div class="box-header">
				<h3>üìÖ Kommende Events</h3>
			</div>
			<div class="box-content">
				<div class="event-list">
					<a
						href="https://meetup.enogtyve.org"
						target="_blank"
						rel="noopener noreferrer"
						class="event-item"
					>
						<div class="event-date-block">
							<div class="event-day">21</div>
							<div class="event-month">HVER MD.</div>
						</div>
						<div class="event-details">
							<div class="event-title">Meetup Caf√© Kodan</div>
							<div class="event-time">
								Den 21. kl. 19:00 i hver m√•ned
							</div>
						</div>
					</a>
					<a
						href="https://www.bitcoincopenhagen.dk"
						target="_blank"
						rel="noopener noreferrer"
						class="event-item"
					>
						<div class="event-date-block">
							<div class="event-day">21</div>
							<div class="event-month">MARTS</div>
						</div>
						<div class="event-details">
							<div class="event-title">Bitcoin Copenhagen</div>
							<div class="event-time">
								Heldags konference ¬∑ Marskensgade 7, K√∏benhavn √ò
							</div>
						</div>
					</a>
				</div>
			</div>
		</div>

		<div class="showcase-box stacker-news">
			<div class="box-header">
				<h3>‚ö° Seneste nyheder fra Stacker.news</h3>
				<span class="box-badge">Stacker News</span>
			</div>
			<div class="box-content" id="stacker-news-list">
				<a href="#" class="news-item placeholder">
					<div class="news-title">Henter artikler...</div>
				</a>
			</div>
		</div>
	</div>
</section>

<script is:inline>
	async function fetchStackerNews() {
	  var container = document.getElementById("stacker-news-list");
	  if (!container) return;
	  try {
		var res = await fetch("/.netlify/functions/stacker-news");
		var posts = await res.json();
		if (!posts.length) {
		  container.innerHTML = '<div class="news-item placeholder"><div class="news-title">Ingen artikler fundet</div></div>';
		  return;
		}
		container.innerHTML = posts.map(function(post) {
		  var date = post.pubDate ? new Date(post.pubDate).toLocaleDateString("da-DK", { day: "2-digit", month: "2-digit", year: "numeric" }) : "";
		  return '<a href="' + post.link + '" target="_blank" rel="noopener noreferrer" class="news-item"><div class="news-date">' + date + '</div><div class="news-title">' + post.title + '</div><div class="news-excerpt">af ' + post.author + '</div></a>';
		}).join("");
	  } catch (e) {
		console.error("Failed to fetch Stacker News:", e);
		if (container) {
		  container.innerHTML = '<div class="news-item placeholder"><div class="news-title">Kunne ikke hente artikler</div></div>';
		}
	  }
	}
	fetchStackerNews();
  </script>

<style>
	.content-showcase {
		padding: clamp(2.5rem, 6vh, 4rem) 0;
		background: linear-gradient(
			180deg,
			transparent 0%,
			rgba(247, 147, 26, 0.02) 100%
		);
	}

	.showcase-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr));
		gap: clamp(1.25rem, 3vw, 1.75rem);
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	.showcase-box {
		background: rgba(255, 255, 255, 0.02);
		border: 1px solid rgba(247, 147, 26, 0.15);
		border-radius: 12px;
		padding: 0;
		overflow: hidden;
		transition: all 0.3s ease;
	}

	.showcase-box:hover {
		border-color: rgba(247, 147, 26, 0.3);
		transform: translateY(-4px);
		box-shadow: 0 8px 24px rgba(247, 147, 26, 0.15);
	}

	.showcase-box.upcoming-events:hover {
		transform: none;
		box-shadow: none;
	}

	.box-header {
		padding: 1.25rem;
		border-bottom: 1px solid rgba(247, 147, 26, 0.1);
		display: flex;
		justify-content: space-between;
		align-items: center;
		background: rgba(247, 147, 26, 0.03);
	}

	.box-header h3 {
		margin: 0;
		font-size: 1rem;
		font-weight: 600;
		color: var(--text);
	}

	.box-badge {
		font-size: 0.65rem;
		padding: 0.25rem 0.65rem;
		background: var(--primary);
		color: #000;
		border-radius: 12px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.box-content {
		padding: 1.25rem;
	}

	/* News items (shared by blog posts and stacker news) */
	a.news-item,
	:global(#stacker-news-list a.news-item) {
		text-decoration: none;
		color: inherit;
		display: block;
		padding: 0.85rem;
		margin: 0 -0.85rem;
		border-bottom: 1px solid rgba(247, 147, 26, 0.08);
		border-radius: 8px;
		transition: background 0.2s ease;
	}

	a.news-item:last-child,
	:global(#stacker-news-list a.news-item:last-child) {
		border-bottom: none;
	}

	a.news-item:hover,
	:global(#stacker-news-list a.news-item:hover) {
		background: rgba(247, 147, 26, 0.05);
	}

	.news-date,
	:global(#stacker-news-list .news-date) {
		font-size: 0.7rem;
		color: var(--primary);
		font-weight: 600;
		margin-bottom: 0.25rem;
		text-transform: uppercase;
	}

	.news-title,
	:global(#stacker-news-list .news-title) {
		font-weight: 600;
		font-size: 0.95rem;
		color: var(--text);
		margin-bottom: 0.25rem;
	}

	.news-excerpt,
	:global(#stacker-news-list .news-excerpt) {
		font-size: 0.85rem;
		color: var(--text-light);
		line-height: 1.4;
	}

	/* Events */
	.event-list {
		display: flex;
		flex-direction: column;
		gap: 0.85rem;
	}

	.event-item {
		display: flex;
		gap: 0.85rem;
		padding: 0.85rem;
		background: rgba(247, 147, 26, 0.03);
		border-radius: 10px;
		border: 1px solid rgba(247, 147, 26, 0.1);
	}

	a.event-item {
		text-decoration: none;
		color: inherit;
		transition:
			border-color 0.2s ease,
			background 0.2s ease,
			transform 0.2s ease,
			box-shadow 0.2s ease;
	}

	a.event-item:hover {
		border-color: rgba(247, 147, 26, 0.35);
		background: rgba(247, 147, 26, 0.06);
		transform: translateY(-3px);
		box-shadow: 0 6px 16px rgba(247, 147, 26, 0.15);
	}

	.event-date-block {
		text-align: center;
		min-width: 55px;
		padding: 0.5rem;
		background: var(--primary);
		color: #000;
		border-radius: 8px;
		font-weight: 700;
	}

	.event-day {
		font-size: 1.35rem;
		line-height: 1;
	}

	.event-month {
		font-size: 0.7rem;
		text-transform: uppercase;
		margin-top: 0.25rem;
	}

	.event-details {
		flex: 1;
	}

	.event-title {
		font-weight: 600;
		font-size: 0.95rem;
		color: var(--text);
		margin-bottom: 0.25rem;
	}

	.event-time {
		font-size: 0.8rem;
		color: var(--text-light);
	}

	.placeholder {
		opacity: 0.6;
	}

	@media (max-width: 767px) {
		.showcase-grid {
			grid-template-columns: 1fr;
		}
	}

	@media (min-width: 768px) {
		.showcase-grid {
			grid-template-columns: repeat(2, 1fr);
		}

		.featured-news {
			grid-column: 1 / -1;
		}
	}
</style>
