---
import "../styles/global.css";
import "../styles/support-modal.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

interface Props {
    title: string;
    description?: string;
    lang?: "da" | "en";
}

const {
    title,
    description = "Enogtyve er Danmarks Bitcoin-fÃ¦llesskab. LÃ¦r om Bitcoin, Lightning Network, opbevaring og meget mere.",
    lang = "da",
} = Astro.props;

const canonicalURL = new URL(
    Astro.url.pathname,
    "https://enogtyve.org",
).toString();
const daPath =
    "https://enogtyve.org/da" + Astro.url.pathname.replace(/^\/(da|en)/, "");
const enPath =
    "https://enogtyve.org/en" + Astro.url.pathname.replace(/^\/(da|en)/, "");

const structuredData = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Enogtyve",
    "url": "https://enogtyve.org",
    "description": description,
    "inLanguage": lang === "da" ? "da-DK" : "en-US"
};
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content={description} />
        <meta name="theme-color" content="#F7931A" />
        <title>{title} | Enogtyve</title>
        <link rel="icon" type="image/png" href="/favicon.png" />
        <link rel="canonical" href={canonicalURL} />
        <link rel="preconnect" href="https://cloud.umami.is" />
        <link rel="preconnect" href="https://btcpay.ideasarelikeflames.org" />

        <!-- hreflang -->
        <link rel="alternate" hreflang="da" href={daPath} />
        <link rel="alternate" hreflang="en" href={enPath} />
        <link rel="alternate" hreflang="x-default" href={daPath} />

        <!-- Open Graph -->
        <meta property="og:title" content={`${title} | Enogtyve`} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonicalURL} />
        <meta
            property="og:image"
            content="https://enogtyve.org/images/logos/enogtyve_logo.png"
        />
        <meta
            property="og:locale"
            content={lang === "da" ? "da_DK" : "en_US"}
        />
        <meta property="og:site_name" content="Enogtyve" />

        <!-- Twitter/X -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content={`${title} | Enogtyve`} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content="https://enogtyve.org/images/logos/enogtyve_logo.png" />

        <!-- JSON-LD -->
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

        <!-- Umami Analytics -->
        <script
            defer
            src="https://cloud.umami.is/script.js"
            data-website-id="ab69f237-947e-44f2-972f-ccdba2c4cd19"></script>
    </head>
    <body>
        <a href="#main" class="skip-link">Spring til indhold</a>

        <Header lang={lang} />

        <main id="main">
            <slot />
        </main>

        <Footer lang={lang} />

        <!-- Support Modal -->
        <div
            class="support-overlay"
            id="supportOverlay"
        >
            <div
                class="support-modal"
                role="dialog"
                aria-modal="true"
                aria-labelledby="supportModalTitle"
            >
                <button class="close-btn" id="supportCloseBtn">&times;</button>

                <div class="icon-wrap">ðŸ§¡</div>
                <h2 id="supportModalTitle">Proof of Heart</h2>
                <p class="subtitle">Tak for din opbakning!</p>

                <div class="divider"></div>

                <div class="btcpay-wrap">
                    <div class="amount-label">VÃ¦lg belÃ¸b</div>

                    <form
                        method="POST"
                        action="https://btcpay.ideasarelikeflames.org/api/v1/invoices"
                        class="btcpay-form btcpay-form--block"
                    >
                        <input
                            type="hidden"
                            name="storeId"
                            value="GL4Us2RE6nDJhwXMUMgagN9efPYpMs1ebZwx9MxQG3qN"
                        />
                        <input
                            type="hidden"
                            name="browserRedirect"
                            value="https://www.enogtyve.org"
                        />
                        <div class="btcpay-custom-container">
                            <div class="btcpay-custom">
                                <button
                                    class="plus-minus"
                                    type="button"
                                    data-type="-"
                                    data-step="21"
                                    data-min="21"
                                    data-max="21000">âˆ’</button
                                >
                                <input
                                    class="btcpay-input-price"
                                    type="number"
                                    name="price"
                                    min="21"
                                    max="21000"
                                    step="21"
                                    value="21"
                                    data-price="21"
                                />
                                <button
                                    class="plus-minus"
                                    type="button"
                                    data-type="+"
                                    data-step="21"
                                    data-min="21"
                                    data-max="21000">+</button
                                >
                            </div>
                            <select name="currency">
                                <option value="DKK" selected>DKK</option>
                                <option value="USD">USD</option>
                                <option value="GBP">GBP</option>
                                <option value="EUR">EUR</option>
                                <option value="BTC">BTC</option>
                            </select>
                        </div>
                        <button
                            type="submit"
                            class="submit"
                            name="submit"
                            title="Pay with BTCPay Server, a Self-Hosted Bitcoin Payment Processor"
                        >
                            <span>Bidrag med</span>
                            <img
                                src="https://btcpay.ideasarelikeflames.org/img/paybutton/logo.svg"
                                alt="BTCPay"
                            />
                        </button>
                    </form>
                </div>

                <span class="footnote">Drevet af BTCPay Server</span>
            </div>
        </div>
        <script is:inline>
            function openSupport() {
                const overlay = document.getElementById("supportOverlay");
                overlay.classList.add("active");
                // Store previously focused element and move focus into modal
                overlay._previousFocus = document.activeElement;
                document.getElementById("supportCloseBtn").focus();
                // Trap focus inside modal
                overlay.addEventListener("keydown", trapFocus);
            }

            function closeSupport(e) {
                if (!e || e.target === e.currentTarget) {
                    const overlay = document.getElementById("supportOverlay");
                    overlay.classList.remove("active");
                    overlay.removeEventListener("keydown", trapFocus);
                    // Restore focus
                    if (overlay._previousFocus) overlay._previousFocus.focus();
                }
            }

            function trapFocus(e) {
                if (e.key !== "Tab") return;
                const modal = document.querySelector(".support-modal");
                const focusable = modal.querySelectorAll(
                    'button, input, select, [tabindex]:not([tabindex="-1"])'
                );
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    }
                } else {
                    if (document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
            }

            document.getElementById("supportOverlay").addEventListener("click", closeSupport);
            document.getElementById("supportCloseBtn").addEventListener("click", () => closeSupport());

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") closeSupport();
            });

            document
                .querySelectorAll(".btcpay-form .plus-minus")
                .forEach(function (el) {
                    el.addEventListener("click", function (event) {
                        event.preventDefault();
                        const root = event.target.closest(".btcpay-form");
                        const input = root.querySelector(".btcpay-input-price");
                        const step = parseInt(event.target.dataset.step) || 1;
                        const min = parseInt(event.target.dataset.min) || 1;
                        const max = parseInt(event.target.dataset.max);
                        const type = event.target.dataset.type;
                        const price = parseInt(input.value) || min;
                        if (type === "-") {
                            input.value = price - step < min ? min : price - step;
                        } else if (type === "+") {
                            input.value = price + step > max ? max : price + step;
                        }
                    });
                });

            document
                .querySelectorAll(".btcpay-form .btcpay-input-price")
                .forEach(function (el) {
                    el.addEventListener("input", function (event) {
                        event.preventDefault();
                        const price = parseInt(event.target.dataset.price);
                        if (isNaN(event.target.value)) event.target.value = price;
                        const min = parseInt(event.target.getAttribute("min")) || 1;
                        const max = parseInt(event.target.getAttribute("max"));
                        if (event.target.value < min) event.target.value = min;
                        else if (event.target.value > max) event.target.value = max;
                    });
                });
        </script>
    </body>
</html>

<style>
    main {
        min-height: 70vh;
        padding: var(--space-sm) 0;
    }

    .skip-link {
        position: absolute;
        top: -100%;
        left: 1rem;
        background: var(--primary);
        color: #000;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 0 0 8px 8px;
        z-index: 9999;
        transition: top 0.2s ease;
    }

    .skip-link:focus {
        top: 0;
    }
</style>